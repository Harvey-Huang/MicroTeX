<!doctype html>

<html>

<head>
    <meta charset="utf-8">
</head>

<body>
<script src="clatexmath-wasm.js"></script>
<script>
    /** Copy typed array to wasm memory */
    function copyToHeap(arrayBuffer) {
        const numBytes = arrayBuffer.byteLength;
        const ptr = Module._malloc(numBytes);
        const heapBytes = new Uint8Array(Module.HEAPU8.buffer, ptr, numBytes);
        heapBytes.set(new Uint8Array(arrayBuffer));
        return ptr;
    }

    /** Free a wasm memory */
    function freeHeap(ptr) {
        Module._free(ptr);
    }

    Module.onRuntimeInitialized = function () {
        fetch(
            "XITSMath-Regular-path.clm",
            {
                headers: {
                    "Accept-Encoding": "gzip, deflate, br"
                }
            })
            .then(res => res.arrayBuffer())
            .then(buf => {
                console.log("clm data size: " + buf.byteLength)
                const xits = allocateUTF8("xits");
                const ptr = copyToHeap(buf);
                try {
                    Module._clatex_init(xits, buf.byteLength, ptr);
                } finally {
                    freeHeap(ptr);
                }
                const isInited = Module._clatex_isInited();
                console.log("clatex inited: " + isInited);

                const tex = allocateUTF8("\\Delta=\\frac{-b\\pm\\sqrt{b^2-4ac}}{2a}");
                const render = Module._clatex_parseRender(tex, 1024, 30, 10, 0x424242);
                console.log("render: " + render);

                let isLittleEndian = Module._clatex_isLittleEndian();

                const cmds = Module._clatex_getDrawingData(render, 0, 0);
                let view = new DataView(wasmMemory.buffer);
                const len = view.getInt32(cmds, isLittleEndian);
                console.log("drawing data size: " + len);

                Module._clatex_deleteRender(render);
            });
    }
</script>
</body>

</html>