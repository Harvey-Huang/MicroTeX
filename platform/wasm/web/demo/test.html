<!doctype html>

<html lang="zh">

<head>
  <title>Hello</title>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="styles.css">
</head>

<body>
<script src="../dist/index.js"></script>
<script>
  tinytex
    .context
    .init("./res/XITSMath-Regular-path.clm")
    .then(_ => {
      const hello = `
      \\text{Hello Tiny\\kern-.15em\\TeX.}\\\\
      \\text{Press ctrl + enter to show.}
      `.trim();
      parse(hello);
      document.getElementById("editor").value = hello;
      listenEdit();
    });

  function listenEdit() {
    document.getElementById("editor").addEventListener("keypress", ev => {
      if (ev.ctrlKey && ev.key === "Enter") {
        show();
      }
    });
  }

  function fixDpi(canvas) {
    let dpi = window.devicePixelRatio;
    let sw = +getComputedStyle(canvas).getPropertyValue("width").slice(0, -2);
    let sh = +getComputedStyle(canvas).getPropertyValue("height").slice(0, -2);
    console.log(`style size: ${sw}, ${sh}, ${dpi}`);
    // scale
    canvas.setAttribute('width', sw * dpi);
    canvas.setAttribute('height', sh * dpi);
  }

  function parse(str) {
    const sizeStr = document.getElementById("textsize").value;
    const size = parseInt(sizeStr);
    const r = tinytex.context.parseRender(str, 1000, size, size / 3, 0x3b3b3b);
    const canvas = document.createElement("canvas");
    canvas.style.width = +r.getWidth() + "px";
    canvas.style.height = +r.getHeight() + "px";
    // append to left
    const left = document.getElementById("left");
    left.replaceChildren();
    left.appendChild(canvas);
    // fix dpi
    fixDpi(canvas);
    // draw the render
    const ctx = canvas.getContext('2d');
    ctx.translate(0.5, 0.5);
    r.draw(ctx, 0, 0);
    r.release();
  }

  function show() {
    if (!tinytex.context.isInited()) {
      return;
    }
    const t = document.getElementById("editor");
    parse(t.value);
  }
</script>

<div class="topmost">
  <div class="container">
    <div class="left" id="left"></div>
    <div class="right">
      <textarea class="editor" id="editor"></textarea>
      <div class="bottom">
        <label>Change text size:</label>
        <input class="textsize" id="textsize" type="number" min="5" max="100" step="2" value="20"/>
        <button class="show" onclick="show()">Show</button>
        <button class="next" id="next">Next example</button>
      </div>
    </div>
  </div>
</div>
</body>

</html>
