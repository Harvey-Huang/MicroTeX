<!doctype html>

<html lang="zh">

<head>
  <title>Hello</title>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="styles.css">
</head>

<body>
<script src="../dist/index.js"></script>
<script
    src="https://pagecdn.io/lib/ace/1.4.13/ace.min.js"
    crossorigin="anonymous"
    integrity="sha256-GjtAsBCI/KPlEYQf0I8yNimcThRoWMnk7Vpi+dUt+GY="></script>
<script src="https://pagecdn.io/lib/ace/1.4.13/mode-latex.min.js" crossorigin="anonymous"></script>

<script>
  let editor = null;

  tinytex
    .context
    .init("./res/XITSMath-Regular-path.clm")
    .then(_ => {
      const hello = `\\text{Hello Tiny\\kern-.15em\\TeX.}\\\\\\text{Press [Ctrl + Enter] to show.}`;
      initEditor();
      parse(hello);
      editor.setValue(hello);
      listenEdit();
    });

  function initEditor() {
    editor = ace.edit("editor");
    editor.session.setMode("ace/mode/latex");
    editor.getSession().setTabSize(2);
  }

  function listenEdit() {
    editor.addEventListener("keypress", ev => {
      if (ev.ctrlKey && ev.key === "Enter") {
        show();
      }
    });
  }

  function fixDpi(canvas) {
    let dpi = window.devicePixelRatio || 1;
    if (dpi === 1) return;
    let sw = +getComputedStyle(canvas).getPropertyValue("width").slice(0, -2);
    let sh = +getComputedStyle(canvas).getPropertyValue("height").slice(0, -2);
    console.log(`style size: ${sw}, ${sh}, ${dpi}`);
    // scale
    canvas.width = sw * dpi;
    canvas.height = sh * dpi;
  }

  function parse(str) {
    const sizeStr = document.getElementById("textsize").value;
    const size = parseInt(sizeStr);
    const r = tinytex.context.parseRender(str, 1000, size, size / 3, 0x3b3b3b);

    const left = document.getElementById("wrapper");
    left.replaceChildren();

    function attach() {
      const canvas = document.createElement("canvas");
      canvas.style.width = (r.getWidth() + 4) + "px";
      canvas.style.height = (r.getHeight() + 4) + "px";
      canvas.width = r.getWidth() + 4;
      canvas.height = r.getHeight() + 4;
      // append to left
      left.appendChild(canvas);
      // fix dpi
      fixDpi(canvas);
      return canvas;
    }

    // draw the render
    function draw(canvas) {
      const ctx = canvas.getContext('2d');
      ctx.translate(2, 2);
      r.draw(ctx, 0, 0);
    }

    const canvas = attach();
    draw(canvas);

    r.release();
  }

  function show() {
    if (!tinytex.context.isInited()) {
      return;
    }
    parse(editor.getValue());
  }

  function Examples(examplesUrl) {
    let isInited = false;

    this.isInited = function () {
      return isInited;
    }

    fetch(examplesUrl)
      .then(res => res.text())
      .then(txt => readExamples(txt));

    let samples = [];
    let i = -1;

    function readExamples(txt) {
      const lines = txt.split(/\r?\n/);
      let str = "";
      lines.forEach(v => {
        if (/^%+$/.test(v)) {
          samples.push(str);
          str = "";
        } else {
          str += v + "\n";
        }
      });
      isInited = true;
    }

    this.count = function () {
      return samples.length;
    }

    this.next = function () {
      i = (i + 1) % this.count();
      return samples[i];
    }
  }

  const examples = new Examples('./res/SAMPLES.tex');

  function next() {
    if (!examples.isInited()) {
      return;
    }
    let str = examples.next();
    parse(str);
    editor.setValue(str);
  }
</script>

<div class="topmost">
  <div class="container">

    <div class="left" id="left">
      <div id="wrapper"></div>
    </div>

    <div class="right">
      <div class="editor" id="editor"></div>
      <div class="bottom">
        <label>Change text size:</label>
        <input class="textsize" id="textsize" type="number" min="5" max="100" step="2" value="30"/>
        <button class="show" onclick="show()">Show</button>
        <button class="next" onclick="next()">Next example</button>
      </div>
    </div>
  </div>
</div>

</body>

</html>
